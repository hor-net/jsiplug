<html lang="en" data-bs-theme="light" style="font-size:16px">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>jsiplug example</title>
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <link href="https://fonts.googleapis.com/css2?family=Titillium+Web&amp;family=Oxanium&amp;display=swap" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.4/font/bootstrap-icons.css">
    </head>
    <body class="bg-body container-fluid">
        <h1>Controls examples</h1>
        <hr>
        
        <h3>Draggable input</h3>
        <label for="draggable-input" class="col-form-label">Draggable input</label>
        <div class="input-group input-group-sm text-center mx-auto control">
            <input type="number" class="form-control text-end" aria-label="draggable input" id="draggable-input" data-controltype="draggable-input" data-paramid="1" data-min="1" data-max="100" data-step="1" data-default="50">
            <span class="input-group-text">%</span>
        </div>
        
        <h3>Select</h3>
        <label for="select-input" class="col-form-label">Select input</label>
        <select class="form-select form-select-sm control" id="select-input" data-controltype="select" data-paramid="2">
            <option value="0">Option 1</option>
            <option value="1">Option 2</option>
            <option value="2">Option 3</option>
        </select>
        
        <h3>Switch</h3>
        <div class="form-check form-switch">
            <input class="form-check-input control" type="checkbox" role="switch" id="switch-on-off" data-controltype="switch" data-paramid="3">
        </div>
        
        <h3>Knob</h3>
        <div class="w-25">
            <svg class="col-5 p-0" viewBox="0 0 34 34" version="1.1" data-controltype="knob" data-paramid="4" data-min="1" data-max="100" data-step="1" data-default="25" id="knob" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg">       
                <g id="layer1" class="knob">
                    <g class="rotator control knob-body" style="transform-origin-x: 50%; transform-origin-y: 50%;">
                        <circle cx="17" cy="17" r="15" fill="#fff" stroke="#000"></circle>
                        <rect width="2" height="15" x="16" y="1" rx="0.7" ry="0.7" class="knob-indicator"></rect>
                    </g>
                </g>
            </svg>
            <div class="input-group input-group-sm text-center mx-auto control">
                <input type="number" class="form-control text-end" aria-label="draggable input" id="knob-val">
                <span class="input-group-text">%</span>
            </div>
        </div>
        <h3>Spectrum</h3>
        <div class="container-fluid p-3">
            <!-- Add decay time slider -->
            <div class="mb-3">
                <label for="decay-time-slider" class="form-label">Decay Time: <span id="decay-time-display">300ms</span></label>
                <input type="range" class="form-range" id="decay-time-slider" 
                       min="0" max="100" value="50">
            </div>
            
            <div id="spectrum-chart" 
                style="width: 100%; height: 400px; margin: 0 auto;" 
                data-controltype="spectrum-chart" 
                data-messageid="1"
                data-mindb="-120"
                data-maxdb="0"
                data-decaytime="300">
            </div>
            <script>
                addEventListener('ControlSetup', (event) => {
                    const chart = GetControlById("spectrum-chart");
                    const decaySlider = document.getElementById('decay-time-slider');
                    const decayDisplay = document.getElementById('decay-time-display');
                    
                    // Convert slider value (0-100) to decay time (100ms-10000ms) logarithmically
                    const getDecayTime = (sliderValue) => {
                        const minLog = Math.log10(100);    // 100ms
                        const maxLog = Math.log10(10000);  // 10s
                        const scale = (maxLog - minLog) / 100;
                        return Math.round(Math.pow(10, minLog + (sliderValue * scale)));
                    };
                    
                    // Update decay time when slider changes
                    decaySlider.addEventListener('input', (e) => {
                        const decayTime = getDecayTime(e.target.value);
                        const displayText = decayTime >= 1000 ? 
                            `${(decayTime/1000).toFixed(1)}s` : 
                            `${decayTime}ms`;
                        decayDisplay.textContent = displayText;
                        chart.updatePreferences({ decayTime });
                    });

                    chart.updatePreferences({
                        grid: {
                            normalLine: {
                                width: 1,
                                color: 'rgba(0,0,0,0.3)'
                            },
                            emphasizedLine: {
                                width: 1,
                                color: 'rgba(0,0,0,1)'
                            }
                        },
                        text: {
                            color: 'rgba(0,0,0,0.8)',
                            normal: {
                                font: 'Titillium Web',
                                size: 12,
                                weight: 'normal'
                            },
                            emphasized: {
                                font: 'Titillium Web',
                                size: 12,
                                weight: 'normal'
                            }
                        },
                        background: 'rgb(225,225,225)',
                        spectrum: {
                            lineColor: '#FF4081',
                            fillColor: 'rgba(255, 64, 129, 0.3)',
                            peakColor: '#FFC107'  // Yellow peak hold line
                        },
                        decayTime: getDecayTime(50) // Initial decay time
                    });

                    // Generate spectrum data every 100ms
                    setInterval(() => {
                        // Create array with logarithmically spaced frequencies
                        const data = new Array(200).fill(0).map((_, index) => {
                            // Calculate frequency for this point (logarithmic distribution)
                            const freq = 20 * Math.pow(1000, index / 199);
                            // Generate a smooth curve with some randomness
                            const baseLevel = -80;
                            const randomVariation = Math.random() * 40;
                            // Add some frequency-dependent variation
                            const freqFactor = Math.sin(2 * Math.PI * freq / 1000) * 20;
                            return baseLevel + randomVariation + freqFactor;
                        });
                        
                        chart.updateSpectrum(data);
                    }, 50);
                });
            </script>
        </div>
        <hr>
        <script type="text/javascript" src="iplug2.js"></script>
        <script type="text/javascript" src="icontrols.js"></script>
        <script type="text/javascript" src="iSpectrumChart.js"></script>
    </body>
</html>